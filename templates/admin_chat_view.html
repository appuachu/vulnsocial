{% extends "base.html" %}

{% block content %}
<div class="admin-container">
    <h2>Admin Panel - Chat Monitoring</h2>

    <div class="admin-nav">
        <a href="{{ url_for('admin') }}" class="admin-nav-btn">Manage Users</a>
        <a href="{{ url_for('admin_user_chats') }}" class="admin-nav-btn">View Chats</a>
        <a href="{{ url_for('index') }}" class="admin-nav-btn">Back to App</a>
    </div>

    <div class="chat-view-header">
        <h3>Chat between {{ user1.username }} (ID: {{ user1.id }}) and {{ user2.username }} (ID: {{ user2.id }})</h3>
        <a href="{{ url_for('admin_user_chats') }}" class="btn-back">‚Üê Back to Chat List</a>
    </div>

    <div class="chat-info-stats">
        <div class="stat-card">
            <strong>Total Messages:</strong> {{ messages|length }}
        </div>
        <div class="stat-card">
            <strong>Active Messages:</strong>
            {{ messages|selectattr('deleted_for_everyone', 'equalto', false)|list|length }}
        </div>
        <div class="stat-card">
            <strong>Deleted for Everyone:</strong>
            {{ messages|selectattr('deleted_for_everyone')|list|length }}
        </div>
        <div class="stat-card">
            <strong>Deleted for Sender:</strong>
            {{ messages|selectattr('deleted_for_sender')|list|length }}
        </div>
        <div class="stat-card">
            <strong>Deleted for Receiver:</strong>
            {{ messages|selectattr('deleted_for_receiver')|list|length }}
        </div>
    </div>

    <div class="chat-container">
        <div class="messages-container">
            {% if messages %}
                {% for message in messages %}
                <div class="message
                            {% if message.sender_id == user1.id %}message-sent{% else %}message-received{% endif %}
                            {% if message.deleted_for_everyone %}message-deleted-everyone{% endif %}
                            {% if message.deleted_for_sender and not message.deleted_for_everyone %}message-deleted-sender{% endif %}
                            {% if message.deleted_for_receiver and not message.deleted_for_everyone %}message-deleted-receiver{% endif %}">

                    <div class="message-header">
                        <div class="sender-info">
                            <strong>
                                {% if message.sender_id == user1.id %}
                                    {{ user1.username }}
                                {% else %}
                                    {{ user2.username }}
                                {% endif %}
                                (ID: {{ message.sender_id }})
                            </strong>
                            <span class="message-time">{{ message.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</span>
                        </div>
                        <div class="message-status">
                            {% if message.deleted_for_everyone %}
                                <span class="status-badge status-deleted-everyone">üóëÔ∏è Deleted for Everyone</span>
                            {% elif message.deleted_for_sender and message.deleted_for_receiver %}
                                <span class="status-badge status-deleted-both">üóëÔ∏è Deleted for Both</span>
                            {% elif message.deleted_for_sender %}
                                <span class="status-badge status-deleted-sender">üóëÔ∏è Deleted for Sender</span>
                            {% elif message.deleted_for_receiver %}
                                <span class="status-badge status-deleted-receiver">üóëÔ∏è Deleted for Receiver</span>
                            {% else %}
                                <span class="status-badge status-active">‚úÖ Active</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="message-content">
                        {% if message.deleted_for_everyone %}
                            <div class="deleted-message">
                                <span class="deleted-icon">üö´</span>
                                <em>This message was deleted for everyone</em>
                                <div class="original-content">
                                    <strong>Original Message:</strong> "{{ message.text }}"
                                </div>
                            </div>
                        {% elif message.deleted_for_sender and message.sender_id == user1.id %}
                            <div class="deleted-message">
                                <span class="deleted-icon">üóëÔ∏è</span>
                                <em>This message was deleted by sender ({{ user1.username }})</em>
                                <div class="original-content">
                                    <strong>Original Message:</strong> "{{ message.text }}"
                                </div>
                            </div>
                        {% elif message.deleted_for_receiver and message.receiver_id == user1.id %}
                            <div class="deleted-message">
                                <span class="deleted-icon">üóëÔ∏è</span>
                                <em>This message was deleted by receiver ({{ user1.username }})</em>
                                <div class="original-content">
                                    <strong>Original Message:</strong> "{{ message.text }}"
                                </div>
                            </div>
                        {% elif message.deleted_for_sender and message.sender_id == user2.id %}
                            <div class="deleted-message">
                                <span class="deleted-icon">üóëÔ∏è</span>
                                <em>This message was deleted by sender ({{ user2.username }})</em>
                                <div class="original-content">
                                    <strong>Original Message:</strong> "{{ message.text }}"
                                </div>
                            </div>
                        {% elif message.deleted_for_receiver and message.receiver_id == user2.id %}
                            <div class="deleted-message">
                                <span class="deleted-icon">üóëÔ∏è</span>
                                <em>This message was deleted by receiver ({{ user2.username }})</em>
                                <div class="original-content">
                                    <strong>Original Message:</strong> "{{ message.text }}"
                                </div>
                            </div>
                        {% else %}
                            {{ message.text }}
                        {% endif %}
                    </div>

                    <div class="message-details">
                        <small>
                            <strong>Message ID:</strong> {{ message.id }} |
                            <strong>To:</strong>
                            {% if message.receiver_id == user1.id %}
                                {{ user1.username }}
                            {% else %}
                                {{ user2.username }}
                            {% endif %}
                            (ID: {{ message.receiver_id }})
                        </small>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="no-messages">
                <p>No messages found between these users.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Admin Actions -->
    <div class="admin-actions">
        <h4>Admin Actions</h4>
        <div class="action-buttons">
            <button onclick="exportChat()" class="btn-export">Export Chat</button>
            <button onclick="deleteAllMessages()" class="btn-delete-all">Delete All Messages</button>
        </div>
    </div>
</div>

<script>
function exportChat() {
    const chatData = {
        user1: "{{ user1.username }} (ID: {{ user1.id }})",
        user2: "{{ user2.username }} (ID: {{ user2.id }})",
        total_messages: {{ messages|length }},
        messages: [
            {% for message in messages %}
            {
                id: {{ message.id }},
                sender: "{% if message.sender_id == user1.id %}{{ user1.username }}{% else %}{{ user2.username }}{% endif %}",
                receiver: "{% if message.receiver_id == user1.id %}{{ user1.username }}{% else %}{{ user2.username }}{% endif %}",
                text: "{{ message.text }}",
                timestamp: "{{ message.created_at.strftime('%Y-%m-%d %H:%M:%S') }}",
                status: "{% if message.deleted_for_everyone %}deleted_for_everyone{% elif message.deleted_for_sender and message.deleted_for_receiver %}deleted_for_both{% elif message.deleted_for_sender %}deleted_for_sender{% elif message.deleted_for_receiver %}deleted_for_receiver{% else %}active{% endif %}"
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ]
    };

    const dataStr = JSON.stringify(chatData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'chat_{{ user1.username }}_{{ user2.username }}.json';
    link.click();
    URL.revokeObjectURL(url);
}

function deleteAllMessages() {
    if (confirm('Are you sure you want to delete ALL messages between these users? This action cannot be undone.')) {
        // This would typically call an admin API endpoint
        alert('This would delete all messages. Implementation would require a backend endpoint.');
    }
}
</script>

<style>
.admin-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
}

.chat-view-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 20px 0;
    padding: 20px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 5px;
}

.btn-back {
    background: #636e72;
    color: white;
    padding: 10px 15px;
    text-decoration: none;
    border-radius: 3px;
}

.chat-info-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin: 20px 0;
}

.stat-card {
    background: white;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 5px;
    text-align: center;
}

.stat-card strong {
    display: block;
    margin-bottom: 5px;
    color: #333;
}

.chat-container {
    background: white;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 5px;
    margin-bottom: 20px;
}

.messages-container {
    max-height: 600px;
    overflow-y: auto;
    padding: 10px;
}

.message {
    padding: 15px;
    margin: 10px 0;
    border-radius: 10px;
    max-width: 80%;
    border: 1px solid #e0e0e0;
}

.message-sent {
    background: #e3f2fd;
    margin-left: auto;
    border-bottom-right-radius: 2px;
}

.message-received {
    background: #f5f5f5;
    margin-right: auto;
    border-bottom-left-radius: 2px;
}

.message-deleted-everyone {
    background: #ffebee;
    border: 2px dashed #e57373;
}

.message-deleted-sender {
    background: #fff3e0;
    border: 2px dashed #ffb74d;
}

.message-deleted-receiver {
    background: #e8f5e8;
    border: 2px dashed #81c784;
}

.message-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
}

.sender-info {
    flex: 1;
}

.sender-info strong {
    color: #333;
    font-size: 14px;
}

.message-time {
    font-size: 11px;
    color: #666;
    margin-left: 10px;
}

.message-status {
    text-align: right;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: bold;
}

.status-active {
    background: #e8f5e8;
    color: #2e7d32;
}

.status-deleted-everyone {
    background: #ffebee;
    color: #c62828;
}

.status-deleted-sender {
    background: #fff3e0;
    color: #ef6c00;
}

.status-deleted-receiver {
    background: #e3f2fd;
    color: #1565c0;
}

.status-deleted-both {
    background: #f3e5f5;
    color: #7b1fa2;
}

.message-content {
    margin-bottom: 8px;
    line-height: 1.4;
}

.deleted-message {
    color: #666;
    font-style: italic;
}

.deleted-icon {
    margin-right: 5px;
}

.original-content {
    margin-top: 8px;
    padding: 8px;
    background: rgba(0,0,0,0.05);
    border-radius: 4px;
    border-left: 3px solid #666;
}

.original-content strong {
    color: #333;
}

.message-details {
    border-top: 1px dashed #ddd;
    padding-top: 8px;
    margin-top: 8px;
}

.message-details small {
    color: #888;
    font-size: 10px;
}

.no-messages {
    text-align: center;
    padding: 40px;
    color: #999;
    font-style: italic;
    background: #f9f9f9;
    border-radius: 5px;
}

.admin-actions {
    background: white;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 5px;
    margin-top: 20px;
}

.admin-actions h4 {
    margin: 0 0 15px 0;
    color: #333;
}

.action-buttons {
    display: flex;
    gap: 10px;
}

.btn-export {
    background: #4caf50;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
}

.btn-delete-all {
    background: #f44336;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
}

.btn-export:hover {
    background: #45a049;
}

.btn-delete-all:hover {
    background: #da190b;
}

/* Scrollbar styling */
.messages-container::-webkit-scrollbar {
    width: 8px;
}

.messages-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.messages-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.messages-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>
{% endblock %}

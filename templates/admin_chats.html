{% extends "base.html" %}

{% block content %}
<div class="admin-container">
    <h2>Admin Panel - Chat Management</h2>

    <div class="admin-nav">
        <a href="{{ url_for('admin') }}" class="admin-nav-btn">Manage Users</a>
        <a href="{{ url_for('admin_user_chats') }}" class="admin-nav-btn active">View Chats</a>
        <a href="{{ url_for('index') }}" class="admin-nav-btn">Back to App</a>
    </div>

    <div class="chat-management">
        <div class="users-section">
            <h3>Select User</h3>
            <div class="users-list">
                {% for user in users %}
                <div class="user-item {% if request.args.get('user_id')|int == user.id %}selected{% endif %}"
                     onclick="selectUser({{ user.id }}, '{{ user.username }}')">
                    {{ user.username }} (ID: {{ user.id }})
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="chat-partners-section">
            <h3>Chat Partners for <span id="selectedUsername">-- select user --</span></h3>
            <div id="chatPartnersList" class="partners-list">
                <p class="no-selection">Please select a user to see their chat partners</p>
            </div>
        </div>
    </div>
</div>

<script>
let selectedUserId = null;
let selectedUsername = null;

function selectUser(userId, username) {
    selectedUserId = userId;
    selectedUsername = username;

    // Update UI
    document.querySelectorAll('.user-item').forEach(item => {
        item.classList.remove('selected');
    });
    event.currentTarget.classList.add('selected');
    document.getElementById('selectedUsername').textContent = username;

    // Load chat partners
    loadChatPartners(userId);
}

function loadChatPartners(userId) {
    fetch('/admin/get_user_chat_partners/' + userId)
        .then(response => response.json())
        .then(partners => {
            const container = document.getElementById('chatPartnersList');

            if (partners.length === 0) {
                container.innerHTML = '<p class="no-partners">No chat partners found for this user</p>';
                return;
            }

            let html = '';
            partners.forEach(partner => {
                html += `
                    <div class="partner-item">
                        <div class="partner-info">
                            <strong>${partner.username}</strong> (ID: ${partner.id})
                        </div>
                        <a href="/admin/view_chat/${selectedUserId}/${partner.id}"
                           class="btn-view-chat">View Chat</a>
                    </div>
                `;
            });

            container.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading chat partners:', error);
            document.getElementById('chatPartnersList').innerHTML =
                '<p class="error">Error loading chat partners</p>';
        });
}

// Auto-select user from URL parameter
window.onload = function() {
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('user_id');
    if (userId) {
        const userItem = document.querySelector(`.user-item[onclick*="${userId}"]`);
        if (userItem) {
            const username = userItem.textContent.split(' (ID:')[0];
            selectUser(parseInt(userId), username);
        }
    }
};
</script>

<style>
.chat-management {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 20px;
    margin-top: 20px;
}

.users-section, .chat-partners-section {
    background: white;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 5px;
}

.users-list {
    max-height: 400px;
    overflow-y: auto;
}

.user-item {
    padding: 10px;
    border: 1px solid #eee;
    margin: 5px 0;
    cursor: pointer;
    border-radius: 3px;
}

.user-item:hover {
    background: #f5f5f5;
}

.user-item.selected {
    background: #0095f6;
    color: white;
    border-color: #0095f6;
}

.partners-list {
    max-height: 400px;
    overflow-y: auto;
}

.partner-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    border: 1px solid #eee;
    margin: 5px 0;
    border-radius: 3px;
}

.btn-view-chat {
    background: #00b894;
    color: white;
    padding: 5px 10px;
    text-decoration: none;
    border-radius: 3px;
    font-size: 12px;
}

.no-selection, .no-partners, .error {
    text-align: center;
    color: #999;
    font-style: italic;
    padding: 20px;
}
</style>
{% endblock %}
